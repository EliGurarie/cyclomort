---
title: "Using Cyclomort"
subtitle: "fitting periodic hazard functions"
author: "Elie Gurarie and Peter Thompson"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{cyclomort}
  %\VignetteEncoding{UTF-8}
  %\VignetteEngine{knitr::rmarkdown}
---


```{r setup, include = FALSE}
require(cyclomort)
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

The `cyclomort` package presents a selection of tools for fitting, exploring, and visualizing uni- or multi-modal periodic hazard functions to right-censored mortality data. The central function `fit_cyclomort` returns parametric estimates of the timing of the peak of a mortality season, the duration of that season, and - in cases with multiple seasons - the relative contribution to the overall mortality of that season.  Other functions help summarize, visualize, and perform some statistical tests comparing models. The model and its implementation are described in detail in Gurarie et al. (*in review*), and users are encouraged to read the paper for a deeper understanding of the model and the likelihood estimation of the parameters.  This vignette briefly illustrates the main functions.  


## Underlying wrapped Cauchy hazard model

The underlying hazard model is based on a mixture of a modified wrapped Cauchy-like functions. The basic function is `wc()`  are parameterized in terms of a mean `mu`, a concentration parameter `rho` which ranges from 0 to 1, and a periodicity `tau`.  

```{r plotWC, fig.width = 7, fig.align = "center", echo = FALSE}
require(cyclomort)

curve(wc(x, mu = 100, rho = .7, tau = 365), xlim = c(0,365), n = 1e4, ylab = "hazard", xlab = "time")
curve(wc(x, mu = 100, rho = .5, tau = 365), add = TRUE, col = 2)
curve(wc(x, mu = 100, rho = .3, tau = 365), add = TRUE, col = 3)
legend("topright", col = 1:3, legend = c(.7,.5,.3), title = "rho", lty = 1)
```

The mixture version `mwc()` includes a vector of weights `gammas`.  Several examples (on a periodicity of 1) are illustrated below:

```{r plotMWC, fig.width = 7, fig.align = "center", echo = FALSE}
curve(mwc(x, mus = c(0.125, 0.5), rhos = c(0.7, 0.5), gammas = c(2, 1), tau = 1), xlim = c(0,1), ylab = "hazard", xlab = "time")
curve(mwc(x, mus = c(0.25, 0.75), rhos = c(0.3, 0.8), gammas = c(0.6, 0.4), tau = 1), add = TRUE, col = 2)
curve(mwc(x, mus = c(0.25, 0.5, 0.75), rhos = c(0.6, 0.5, 0.4), gammas = c(0.5, 0.2, 0.3), tau = 1), add = TRUE, col = 3)
```

Note that these functions are not distributions but positive recurring functions whose mean is 1 defined on an infinite support.  Additionally there are functions for the integrals of these functions : `iwc()` and `imwc()` respectively.  This complete set of functions are mainly internal and used for fitting, though they can be useful for visualizing the shape of an underlying hazard.  In subsequent analyses and applications, the parameter `rho` is replaced with a "season duration" parameter, and an additional parameter of the mean overall hazard.  

## Simulating periodic mortality processes

The `simulate_cycloSurv()` function generates time-to-event data from an underlying periodic hazard process.  Note that this function is parameterized via the (spelled-out) parameters: `period`, `meanhazard`, `peaks`, `durations` and `weights`.  By default, this function plots the hazard, cumulative mortality, survival curve, and a histogram of simulated mortalities: 

```{r plotSim, fig.width = 7, fig.height = 5, fig.align = "center", echo = -1}
set.seed(10)
T.morts.sim <- simulate_cycloSurv(300, period = 365, 
                             meanhazard = 1/365, 
                             peaks = c(100, 250), 
                             durations = c(25, 40), 
                             weights = c(0.4, 0.6), 
                             plotme = TRUE,
                             max.periods = 5)
```

The function returns an object of the `cyclomort` specific class `cycloSurv`, which is a superclass of the `Surv` data type used widely in survival anaysis in R:


```{r}
T.morts.sim[1:10]
class(T.morts.sim)
```


## Fitting a periodic hazard process

The `fit_cyclomort()` function estimates the parameters of the periodic hazard process.   Note that we have to specify the numbers of seasons to fit.  

```{r}
T.morts.fit <- fit_cyclomort(T.morts.sim, n.seasons = 2)
```

The returned object is of class `fit_cyclomort`, which has `summary`, `print` and `plot` methods: 

```{r}
print(T.morts.fit)
```

```{r}
summary(T.morts.fit)
```

From the summary, we see that the estimated values are within the 95% confidence intevals of the estimates. 


The default plot:

```{r plotSimFits, fig.width = 7, fig.height = 5, fig.align = "center"}
plot(T.morts.fit, breaks = 30)
```

By default, plots a historgram of the data as well.  It can be useful to plot only the fit and the confidence interval, for example to compare the 2 season fit with a 1 season and null fit, while suppressing the histogram:

```{r, message = FALSE}
T.morts.1season.fit <- fit_cyclomort(T.morts.sim, n.seasons = 1)
T.morts.null.fit <- fit_cyclomort(T.morts.sim, n.seasons = 0)
plot(T.morts.fit, histogram = FALSE, monthlabs = TRUE)
plot(T.morts.1season.fit, histogram = FALSE, add = TRUE, hazcolor = "red")
plot(T.morts.null.fit, histogram = FALSE, add = TRUE, hazcolor = "blue")
```

The confidence intervals illustrated in these plots are 

The plot our fit objects, notice that we include confidence intervals on our estiamtes to display the true accuracy of our fitting process. We do this with the `predict` method (`predict.cmfit` function), which returns a set of predictions for a given fit at a time or set of times. 

Users can also call `predict.cmfit` to estimate the expected time to death for any individual at any given time. *Note, this procedure takes a ***very*** (in fact, embarassingly) long time even with relatively few samples (e.g. 100). We are working on this!* 

```{r, eval = 2, echo = 1}
timetoeventprediction <- predict(T.morts.fit, t = 1:365, type = "timetoevent", CI = TRUE, nreps = 100)
data(timetoeventprediction)
```

The figure below illustrates the extent to which the expected time to an event depends on when an individual "enters" the process. 

```{r TimeToEventPrediction, fig.width = 7, fig.height = 5, fig.align = "center", echo = -1}
par(bty = "l")
with(timetoeventprediction, {
  plot(t, fit, type = "l", ylab = "Time to event", ylim = range(CI), lwd = 2)
  lines(t, CI[1,])
  lines(t, CI[2,])
})
```

## Identifying the number of mortality seasons within a system using select_Seasons

An important aspect of this model fitting is being able to definitively characterize specific aspects of a data set. Identifying the probable number of mortality seasons in a system is a powerful and useful claim that we attempt to help make here with the select_seasons function. This function performs fit_cyclomort for a number of different seasons (ranging from the null model of 0 seasons to max.season), identifying the best model using the Akaike Information Criterion (AIC).

The select_seasons function returns a cmfitlist object which is equipped with unique print and summary functions. cmfitlist objects are simply lists of cmfit objects (each element of the list being the cmfit object representing a different seasonal assumption), but the summary.cmfitlist function allows for easier comparison of the different fits.

```{r}
T.select <- select_seasons(T.morts.sim, max.season = 3)
```

As expected, `select_seasons` function identifies the two season model as the one with the lowest AIC value. 

## Simple factor analyses

The `factorfit_cyclomort` function allows users to test whether or not a categorical variable has an impact on seasonal mortality patterns, using R's formula notation.  The data can be structured as a data frame with a categorical variable and a `Surv` (or `cycloSurv`) object in columns.  There is a simulated dataset in the package called `seasonalsex`:

```{r}
data(seasonalsex)
str(seasonalsex)
```

The implementation is straightforward:

```{r}
Survival.factorfit <- factorfit_cyclomort(event ~ sex, data = seasonalsex, n.seasons = 1)
summary(Survival.factorfit)
```

The analyses reports a p-value based on a likelihood ratio test of a model that includes the factor against a null model that does not, as well as reporting AIC values.  A plotting method provides a visual comparison of the fits.

```{r plotFactorFit, fig.width = 7, fig.height = 5, fig.align = "center"}
plot(Survival.factorfit, ymax = 1.2)
```


## References

E. Gurarie, P. Thompson, A. Kelly,  N. Larter, W. Fagan and K. Joly.  For Everything There is a Season: Estimating periodic hazard functions with the `cyclomort` R package. *Methods in Ecology and Evolution*. 
